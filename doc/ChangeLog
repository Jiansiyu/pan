  ChangeLog
  =========

This is a detailed list of ongoing changes.  Add changes to 
the top of this file.

Changes by R. Holmes on 10 Apr 2002
-----------------------------------

I've made a bunch of changes, mostly in three categories: (1) fixing
compiler warnings (2) improving stats output format and (3) changing
the way cut intervals are updated.

The latter is a little arcane.  The point is that multiple copies of
events get stored -- there's the copy owned by TaRun, the copy in the
event queue, and the copy in a pair in the pair queue, for instance.
(And before going into those queues, they go through the helicity
delay queue.)  The copy in TaRun is the one that gets checked for
event errors, and is later copied into the event and pair queues;
however, it's a copy of this which is put into a pair and checked for
helicity/synch sequence errors.  That means a couple of things.  One,
the event found in the event queue never has pair cuts stored in its
list of failed cuts.  Since event queue events are presumably used
only for the non-pair tree and non-pair analyses, that's not
necessarily a problem.

What is a problem is that the event owned by TaRun also has pair cut
failures indicated.  We were using that copy of the event to update
cut intervals; this means sequence errors were never generating cut
intervals.  Bad thing.

The new scheme is to call a new method in TaRun to update the cut
intervals immediately upon finding each cut condition.  The ugly side
of this is that a couple of pair methods now have run arguments where
they didn't need them before.

Here's a more detailed list of changes:

TaCutList.{cc,hh}

 o Added tally of events that fail cut conditions.

 o Added a vector string to hold cut names, with an access function to
   add a name.  Used by printTally().

 o Added printInt(), printExt(), and printTally() methods, and
   redefined operator<< as a call to all three.

 o Other minor tweaks.

TaDevice.{cc,hh}

 o Added const to both GetKey()s.  For GetKey(Int_t) this then
   required changing the iterator to const_iterator; for
   GetKey(string) I had to replace fKeyToIdx[keystr] by
   (fKeyToIdx.find(keystr))->second .  (You can't index into a const
   map, but you can do a find on it.  I believe this should not change
   the behavior for defined keys, and for undefined keys
   GetKey(string) probably should complain, not just silently return
   zero.

 o Removed const from argument of Init(), since it calls
   DataMapReStart() and NextDataMap() which modify the database object.

 BOB -- PLEASE VERIFY THESE CHANGES ARE OK!

TaEvent.{cc,hh}

 o Added calls to TaRun::UpdateCutList().

 o Other tweaks.

TaFdbkAna.cc

 o Re-ordered constructor initializers to quell a warning.

TaPairFromPair.{cc,hh}

 o Added call to TaRun::UpdateCutList().
 
 o Added run argument to CheckSequence() and Fill().

TaRun.{cc,hh}

 o Added calls to TaCutList::AddName().

 o Stats output format enhancements.

 o Added UpdateCutList() method.

 o Commented out body of AddCuts() method.  (To be removed entirely if
   the new scheme works OK.)

VaAnalysis.cc

 o Added run argument to VaPair::Fill() call.

 o Other tweaks.

VaPair.{cc,hh}

 o Added run argument to Fill().

 o Other tweaks.



Changes by R. Michaels on 6 Apr 2002
-------------------------------------

Studied g++ optimization (flag OPTIMIZE in Makefile).  Gains of 10%
in speed are possible, but the compilation is slower.  Suggest to 
comment out OPTIMIZE if you are frequently compiling code.

Made "Get" methods of TaDevice inline, but it seems these methods get 
inlined anyway with optimization.  

			
Changes by R. Michaels on 5 Apr 2002
-------------------------------------

Before changing anything, I created a "stable release"
    cvs -q tag Stable-version0-5Apr2002
To retrieve this in the future, you may
    cvs checkout -r Stable-version0-5Apr2002
But, you probably never will want to.  Instead, you should
checkout the new code in a CLEAN new working directory.

Massive surgery:  elimination of the classes

   VaDevice  TaADC   TaBCM   TaBPM   TaTIR  TaScaler  TaTB

There is a new class TaDevice which is owned by TaRun.
It contains the data that TaEvent needs to decode devices,
but which doesn't change throughout a run.  

To increase the speed, we use static arrays of data, with 
access by integer indices, not strings.  This is found to be
much faster than hash maps.

In TaEvent the "Get" methods for data are:

   // raw data, index = location in buffer 
       Int_t GetRawData(Int_t index); 
   // get data by unique key
       Double_t GetData(Int_t key);   
   // get raw ADC data in slot and chan (slot & chan starts at 0)
       Double_t GetRawADCData(Int_t slot, Int_t chan);  
   // get calib. ADC data in slot and chan.
       Double_t GetCalADCData(Int_t slot, Int_t chan);  
   // get scaler data in slot and chan.
       GetScalerData(Int_t slot, Int_t chan);  

The "GetData(key)" method uses integer keys defined in
DevTypes.hh.   Examples:

      GetData(IBCM1R);     // gets raw (R) data from BCM1
      GetData(IHELICITY);  // gets the helicity data.

The string names equivalent to these integer keys is
defined in an obvious way in TaDevice::InitKeyList, and
users can determine the correspondence at initialization
using the method of TaRun

      Int_t GetKey(string keystr);  // returns integer key

The string names are still used to define variables in 
the root output trees, in TaLabelledQuantity, etc.  
The VaAnalysis was modified to use a vector of "AnaList"
objects which contain the string names, corresponding
integer keys, and units.

Other details:
  - TaAnalysisManager sets ROOT file compression level to 0
  - Suppress printout of datamap (commented out)

  - Files affected:
     Makefile
     TaADCCalib.cc
     TaAsciiDB.cc
     TaAnalysisManager.cc
     TaBeamAna.cc
     TaEvent.cc
     TaEvent.hh
     TaRun.cc
     TaRun.hh
     VaAnalysis.cc
     VaAnalysis.hh
     VaPair.cc
     VaPair.hh
     TaFdbkAna.cc

  - New files:
     TaDevice.cc
     TaDevice.hh
     DevTypes.hh
	
	
Changes by R. Holmes on 18-19 Mar 2002
----------------------------------------

TaAsciiDB.cc

  o Better error messages for selfcheck of windelay and oversamp;
    oversamp can be up to 12 (is this safe?)

TaEvent.{cc,hh}

  o Add DumpBits for helicity etc. diagnostics

TaPairFromPair.{cc,hh}

  o In Fill(), now check for mismatch between number of 'first' and
    'second' events.  I.e.:

      o If we see a 'first' event immediately after a 'second' event,
        but the event queue is not empty, then we didn't have enough
        'seconds' to pair with all the 'firsts'.

      o If we see a 'second' event while the event queue is empty,
        then we didn't have enough 'firsts' to pair with all the
        'seconds'. 

    In either case we print an error message and return false.  In the
    first case we also clear the event queue and set fgSkipping to
    true if the timeslot isn't 1, to skip events until the start of
    the next 'first' window.  In the second case we always set
    fgSkipping to true.  We do NOT generate a cut but I believe we
    don't need to -- there should always be a sequence cut just before
    or after this.

  o In CheckSequence(), do checks between this window and previous
    window even if timeslot = 1 is not seen.


Changes by R. Holmes on 15 Mar 2002
----------------------------------------

TaRun.cc

  o Various improvements to stats printouts.  Stats are printed when
    pair containing event n*1000 is analyzed, not when that event is
    read.  Printout headers suppressed if there are no stats.  Slice
    stats are printed at end of run, before cumulative stats.

Changes by R. Holmes on 13 Mar 2002
----------------------------------------

TaCutInterval.cc

  o Bug fix: Intervals starting at an event number less than the
    before-extension size were handled incorrectly due to unsigned
    arithmetic. 

TaCutList.cc

  o Multiply extensions from db (now regarded as number of windows) by
    oversample factor to get number of events.
  o Add debug code.

TaRun.cc

  o Better labelling of stats outputs to clarify incremental and
    cumulative stats.
  o Now compute and print stats on all quantities except those
    starting with "Right" or "Left".  This is still something of a
    kludge, but it's a better kludge.

VaAnalysis.hh,cc

  o Replace pair_ok in tree with ok_cond and ok_cut.

VaPair.hh,cc

  o Add PassedCutsInt().


More changes by R. Holmes on 7 Mar 2002
----------------------------------------

TaCutList.cc

  o Return stream from operator<<.
  o Check cut numbers when initializing from database and ignore any
    out of range.

TaCutInterval.cc

  o Return stream from operator<<.


Changes by R. Holmes on 7 Mar 2002
----------------------------------------

TaCutInterval.hh,cc

  o Add operator<< .

TaCutList.hh,cc

  o Initialize cut list and cut extensions from database. (This
    requires a change to the Init interface.) 
  o Add operator<< .

TaEvent.hh,cc

  o Replace data member fCut with fCutFail and fCutPass. 
  o Clear these when loading an event (I'm not sure this is
    necessary). 
  o Call badly-named AddCut for every event cut on every event, with
    value zero when cut is passed, nonzero otherwise.
  o Add GetCutsPassed() as counterpart to GetCuts() (which returns
    cuts failed). 

TaPairFromPair.cc

  o Call badly-named AddCut for every pair cut on every pair, with
  value zero when cut is passed, nonzero otherwise.

TaRun.cc

  o Minor changes required due to above changes in TaCutList and
    TaEvent.
  o A couple of new debug prints (enabled with NOISY).

VaAnalysis.hh,cc

  o Fixed members of pair tree (event numbers and pair_ok) are stored
    in their own variables, not in *fTreeSpace.
  o Initialize fEHelDequeMax to 1 greater than delay * oversample (and 
    eliminate special treatment for delay = 0.)
  o Eliminate "dirty fix" for memory leak (now plugged).

VaPair.cc

  o Change sign convention for differences and asymmetries back to 
    R-L.  (I did this because it is the convention used in HAPPEX I
    and so far as I know all other parity experiments, and because I
    do not know the reason why it was changed to L-R.  If there is a
    problem with R-L please let me know.  There may be a better fix.)
  o Change PassedCuts to return Bool_t, and require both events to be
    good.


Changes by R. Holmes on 5 Mar 2002
----------------------------------------

TaBeamAna 

  o Fix bug in InitChanLists causing BCM asymmetries to be stored
    twice. 

TaRun

  o Changes to prevent Pan from trying to compute and print means and
    widths of things like the helicity and pairsynch bits.  I decided
    on a quick and easy but not necessarily best fix, which is to
    accumulate sums for all "results" (including values of helicity
    and pairsynch) but compute and print means and widths only for
    those whose names start with "Asym" or "Diff".  I would be happy
    to hear suggestions for a better fix, if you have any.

TaStatistics 

  o Remove the error messages from the Neff routines which were
    printed when the statistics vectors are empty; instead it quietly
    returns zero, which is a sensible thing to return.  I think it
    should be legal to call Neff on a possibly empty statistics
    vector.  You still get error messages if you try to e.g. compute a
    mean on an empty vector.




* changes leading to March 1 2002 version
_________________________________________       

TaAnalysisManager -
   Can choose now between two type of analysis, so now the run type and the anatype could
   be different. We still need to put the ana type in the root file name.
         
        
VaAnalysis -
   Added RunInI() set the value of fEHelDequeMax at 1 in case of no 
   helicity delay. This was the main problem why we didn't have 
   the pair tree after a run.   

TaEvent -
   private variable FirstPS was set to 1 to respect the source 
   convention.

TaRun -
   Added event number (ev_num) explicitly in the tree so we don't have to use scaler1_1 to get it.
   Added SendEPICSInfo( pair< string, Double_t> value, pair<string,Double_t> errvalue) to be able 
   to send feedbacks infos to the source.       


VaAnalysis -
         
   Changed the convention for the asymmetry sign  : L - R  


TaFdbkAna -
         
    Derived from VaAnalysis, this is a 'TaBeamAna'  with charge asymmetry feedback implemented.
    will add PZT info if needed.        
        
        
        
        

* Primary changes leading to Feb 8, 2002 version
------------------------------------------------
 
TaAnalysisManager -
   Root file is now pan_%d.dat where %d = run number
   Upon initialization, the database is checked; if it is 'bad' we exit.

TaAsciiDB -
   Added GetMaxEvents()
   Added SelfCheck() - used by analysis manager.
   
TaBCM -
   Modified naming; restriction enforced that bcm1, bcm2 must be 
   different objects (not sure its a good idea but at least its clarified).

TaBeamAna -
   Uses 'bcm1r' and 'bcm1' for raw and corrected data.
   Got rid of the ifdef's since datamap iterator reset works now
      in VaAnalysis::ChanList and TIR is defined.
    
TaEvent -
   Check if event size is changing (it should not).
   Check that keys are unique within a device (see DATABASE.RULES)
   Clearer error messages if a key is not found or rule above broken.
   Provide GetADCData(slot, chan) method.
   Remove ifdef about TIR since it exists now (existence is checked).
   Add DeviceDump() to check all device data.

TaRun -
   If CHECKOUT defined, makes detailed debug printout.

TaTIR -
   Simplified.
   Add timeslot. 
   Call VaDevice::DataCopy so data shows up in Tree.

VaAnalysis -
   if CHECKOUT defined, makes detailed debug printout.
   GetMaxEvents() works now.
   datamap iterator reset before using NextDataMap, this part works now.
   Fixed a memory leak in PreProcessEvt().
 
VaDevice -
   Interface modified to accomodate above changes.
   FindHeaders() does not need a TaEvent.

